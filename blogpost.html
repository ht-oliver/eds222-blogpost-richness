<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Henry Oliver">
<meta name="dcterms.date" content="2025-12-11">

<title>Modeling Precipitation as a Predictor for Fish Species Richness In US Northwest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="blogpost_files/libs/clipboard/clipboard.min.js"></script>
<script src="blogpost_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="blogpost_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="blogpost_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="blogpost_files/libs/quarto-html/popper.min.js"></script>
<script src="blogpost_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="blogpost_files/libs/quarto-html/anchor.min.js"></script>
<link href="blogpost_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="blogpost_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="blogpost_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="blogpost_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="blogpost_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="blogpost_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="blogpost_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Modeling Precipitation as a Predictor for Fish Species Richness In US Northwest</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Henry Oliver </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 11, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Freshwater fish presence and species richness is a vital metric for stream health. Stream health is intrinsically tied to water quality, water availability, agriculture and industrial processes, making it incredibly important to local economies. Moreover, stream health is a major part of the recreation and tourism economies for stream-rich states like Montana, Wyoming, Idaho and the Dakotas. As global heating trends cause decreases in snowfall and increases in air temperature, these streams are at risk, and so are the fish that swim in them. In order to protect stream life, it’s important that we research the relationships between biotic factors and their environment. Precipitation is a key driver of stream conditions, controlling water volume, flow rates, turbidity, and temperature—factors that determine which fish species can thrive in a given stream. By identifying direct relationships between precipitation and species richness, we can build a better idea of how we can expect or freshwater ecological landscape to change in the coming years; and ideally how we can preserve our freshwater resources for future generations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">here</span>(<span class="st">"images"</span>, <span class="st">"big_hole.jpeg"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/big_hole.jpeg" class="img-fluid figure-img" width="1024"></p>
</figure>
</div>
</div>
</div>
<p><em>Big Hole River, Montana, September 2023. Photo credit Henry Oliver</em></p>
</section>
<section id="research-question" class="level2">
<h2 class="anchored" data-anchor-id="research-question">Research Question</h2>
<p>How is freshwater fish diversity affected by precipitation in Northwest rivers and streams?</p>
</section>
<section id="hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="hypothesis">Hypothesis</h2>
<p>The null hypothesis for this experiment is that precipitation has no effect on species richness.</p>
<p><span class="math display">\[H_0: \beta_{\text{precip}} = 0\]</span></p>
<p>The alternative hypothesis is that precipitation has an effect on species richness.</p>
<p><span class="math display">\[H_A: \beta_{\text{precip}} \not= 0\]</span></p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>The data used in the this analysis is the The University of Wyoming Stream Species Dataset[1]. This multi-generational composition is a species presence dataset containing presence locations for 116 freshwater fish species in Wyoming, Montana, and the surrounding states dating back to the year 1900. It contains data from 40,490 unique sample events (location, month, year), and was compiled by combining data from agency databases, the Global Biodiversity Information Facility, university theses, peer-reviewed literature, grey-literature reports, and unpublished data from the University of Wyoming. Please note that absence (0) values only indicate that a species was not recorded by observers and should not be used as true absences in analyses.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">here</span>(<span class="st">"images"</span>, <span class="st">"data-1.png"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/data-1.png" class="img-fluid figure-img" width="1359"></p>
</figure>
</div>
</div>
</div>
<p><em>Raw data from University of Wyoming Stream Species Dataset</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">here</span>(<span class="st">"images"</span>, <span class="st">"data-2.png"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/data-2.png" class="img-fluid figure-img" width="1372"></p>
</figure>
</div>
</div>
</div>
<p><em>Raw data from University of Wyoming Stream Species Dataset</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">here</span>(<span class="st">"images"</span>, <span class="st">"study_area.png"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/study_area.png" class="img-fluid figure-img" width="999"></p>
</figure>
</div>
</div>
</div>
<p><em>Study area for University of Wyoming Stream Species Dataset</em></p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>I’ll be modeling the relationship between precipitation and fish species richness using a negative binomial model.</p>
</section>
<section id="variables-and-dag" class="level2">
<h2 class="anchored" data-anchor-id="variables-and-dag">Variables and DAG</h2>
<p><strong>Precipitation</strong>: Mm precipitation recorded during the month of observation</p>
<p><strong>Base Flow Index (BFI)</strong>: Expression of groundwater vs.&nbsp;surface water flow in for each water body.</p>
<p><strong>Air Temperature</strong>: Average air temperature during the month of August for each river. NOT For each year. These temperatures are a regional average over many years.</p>
<p><strong>Flow</strong>: Many-year average flow rate during the month of August for each river.</p>
<p><strong>Richness</strong>: Number of species observed in a given stream</p>
</section>
<section id="dag" class="level2">
<h2 class="anchored" data-anchor-id="dag">DAG</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dag <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">'</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="st">dag {</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">  "Precipitation" -&gt; "Richness"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">  "Precipitation" -&gt; "Flow" -&gt; "Richness"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">  "Precipitation" -&gt; "BFI" -&gt; "Richness"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">  "AirTemp" -&gt; "Precipitation"</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">  "AirTemp" -&gt; "Richness"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">'</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Dag</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(dag) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blogpost_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This directed acyclic graph (DAG) represents the hypothesized causal relationships between environmental variables and fish species richness in streams. Precipitation has both direct and indirect effects on species richness. Directly, precipitation levels may influence habitat availability and water chemistry. Indirectly, precipitation affects richness through two pathways: stream flow (higher precipitation increases flow rates) and baseflow index (BFI), which measures the proportion of streamflow from groundwater sources vs precipitation for a given stream. Air temperature also plays a dual role – it influences precipitation patterns (warmer air affects rainfall and snowfall) and has a direct effect on species richness by affecting water temperature and the movement and feeding patterns of fish.</p>
</section>
<section id="reading-in-our-fish-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-in-our-fish-data">Reading in our fish data</h2>
<p>This data set has over 40,000 entries of varying quality dating back to 1800. So we’ll want to filter some of that information out. For this analysis, I’ll just be looking at the last available 50 years of data. In order to simplify things, we’ll also only be looking at the month of August, for which average air temperatures and flow rates have been recorded for each stream in the dataset. August is also notably the peak of this fishing season in Montana and Wyoming. The <code>filter()</code> function narrows our time-frame, and the <code>select()</code> function below removes some of the columns that are not necessary for this analysis</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fish_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"StreamSpeciesDataset_v1_1_3_edited.csv"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">1972</span>, year <span class="sc">&lt;=</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span> <span class="co"># 50 Years of data</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"8"</span>)) <span class="co"># Month of august</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Right now, our data table has one column for each species of fish, with a value of 1 or 0 indicating presence or non-presence. For analysis like these, ‘long’ formatted data is better. So we’re going to pivot our columns for each species into two columns, one for ‘species’ and one for ‘presence’.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot longer so that each species has it's own row</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fish_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(fish_raw,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"bct"</span>, <span class="st">"crct"</span>, <span class="st">"crrb"</span>, <span class="st">"eb"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"ll"</span>, <span class="st">"bull"</span>, <span class="st">"gr"</span>, <span class="st">"onc"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"tgt"</span>, <span class="st">"spk"</span>, <span class="st">"srct"</span>, <span class="st">"wct"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"yct"</span>, <span class="st">"cut"</span>, <span class="st">"cis"</span>, <span class="st">"lwf"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"gt"</span>, <span class="st">"rb"</span>, <span class="st">"kok"</span>, <span class="st">"pwf"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"mwf"</span>, <span class="st">"lt"</span>, <span class="st">"lmb"</span>, <span class="st">"smb"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"bg"</span>, <span class="st">"pump"</span>, <span class="st">"gsun"</span>, <span class="st">"blcr"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"whcr"</span>, <span class="st">"wbs"</span>, <span class="st">"rkb"</span>, <span class="st">"nrbdc"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"bmsh"</span>, <span class="st">"cmsh"</span>, <span class="st">"lsch"</span>, <span class="st">"rdsh"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"rtch"</span>, <span class="st">"lkch"</span>, <span class="st">"hhch"</span>, <span class="st">"gila"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"smmn"</span>, <span class="st">"wsmn"</span>, <span class="st">"brmn"</span>, <span class="st">"plmn"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"ws_plmn"</span>, <span class="st">"stch"</span>, <span class="st">"fsdc"</span>, <span class="st">"sfch"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"npdc"</span>, <span class="st">"str"</span>, <span class="st">"pea"</span>, <span class="st">"gsh"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"emsh"</span>, <span class="st">"spsh"</span>, <span class="st">"sdsh"</span>, <span class="st">"fhmn"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"fhch"</span>, <span class="st">"spdc"</span>, <span class="st">"lndc"</span>, <span class="st">"rssh"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"crch"</span>, <span class="st">"gdf"</span>, <span class="st">"carp"</span>, <span class="st">"blbh"</span>, </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"ylbh"</span>, <span class="st">"ccat"</span>, <span class="st">"scat"</span>, <span class="st">"ling"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"drum"</span>, <span class="st">"gar"</span>, <span class="st">"pkf"</span>, <span class="st">"ptmn"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"ge"</span>, <span class="st">"pf"</span>, <span class="st">"iowa"</span>, <span class="st">"jdt"</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"odt"</span>, <span class="st">"yp"</span>, <span class="st">"sgr"</span>, <span class="st">"we"</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"np"</span>, <span class="st">"tim"</span>, <span class="st">"rmcot"</span>, <span class="st">"mcot"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"colcot"</span>, <span class="st">"pcot"</span>, <span class="st">"slcot"</span>, <span class="st">"tcot"</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"spcot"</span>, <span class="st">"cfcot"</span>, <span class="st">"rbsm"</span>, <span class="st">"brsb"</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"wstrg"</span>, <span class="st">"pstrg"</span>, <span class="st">"sstrg"</span>, <span class="st">"rcsu"</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"lnsu"</span>, <span class="st">"wsu"</span>, <span class="st">"lssu"</span>, <span class="st">"mtsu"</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"plsu"</span>, <span class="st">"bsu"</span>, <span class="st">"smbuf"</span>, <span class="st">"bmbuf"</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"bhsu"</span>, <span class="st">"gsu"</span>, <span class="st">"b_hx_wsu"</span>, <span class="st">"fmsu"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"f_mx_bhsu"</span>, <span class="st">"f_mx_wsu"</span>, <span class="st">"utsu"</span>, <span class="st">"qbk"</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"shrh"</span>, <span class="st">"trpr"</span>, <span class="st">"gam"</span>, <span class="st">"gzs"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                                  ),</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                          <span class="at">names_to =</span> <span class="st">"species_0"</span>,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>                          <span class="at">values_to =</span> <span class="st">"present_0"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we still have about 65 columns that we don’t need. Let’s clean it up a bit and only get the columns we want. We’re looking at precipitation, air temperature, base-flow index, flow, and species presence. It also won’t hurt to keep stream names, year and location.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select relevent columns</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fish_long_filtered <span class="ot">&lt;-</span> fish_long <span class="sc">%&gt;%</span>  </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>(gnis_name, month, year, state, precip, air_aug, bfi, flow_aug, present_0, species_0)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s take a look at our data after the transformations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(fish_long_filtered),</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">"Transformed Fish Data"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Transformed Fish Data</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 4%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">gnis_name</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">year</th>
<th style="text-align: left;">state</th>
<th style="text-align: right;">precip</th>
<th style="text-align: right;">air_aug</th>
<th style="text-align: right;">bfi</th>
<th style="text-align: right;">flow_aug</th>
<th style="text-align: right;">present_0</th>
<th style="text-align: left;">species_0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">bct</td>
</tr>
<tr class="even">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">crct</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">crrb</td>
</tr>
<tr class="even">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">eb</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">ll</td>
</tr>
<tr class="even">
<td style="text-align: left;">Spanish Creek</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1980</td>
<td style="text-align: left;">Montana</td>
<td style="text-align: right;">541.11</td>
<td style="text-align: right;">13.68</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">9.71</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">bull</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="data-filtering" class="level2">
<h2 class="anchored" data-anchor-id="data-filtering">Data Filtering</h2>
<p>We want a sum of the number of species observed per river per August of each year, but we don’t want any duplicates of species being counted in the richness, so let’s get a unique richness count for each summer fishing season.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>aug_richness <span class="ot">&lt;-</span> fish_long_filtered <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(present_0 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span>  <span class="co"># Only keep rows where species is present</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gnis_name, year) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">richness =</span> <span class="fu">n_distinct</span>(species_0),  <span class="co"># Count distinct species, avoid duplicates</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_precip =</span> <span class="fu">mean</span>(precip),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bfi =</span> <span class="fu">mean</span>(bfi),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">air_aug =</span> <span class="fu">mean</span>(air_aug),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow_aug =</span> <span class="fu">mean</span>(flow_aug)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s take a look at our raw data</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot richness as a function of precipitation</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(aug_richness, <span class="fu">aes</span>(<span class="at">x =</span> mean_precip, <span class="at">y =</span> richness)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span> <span class="co"># Local smoothing line of best fit</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                                 <span class="co"># Assumes linearity/non-linearity is unknown</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Raw Data: Precipitation vs Species Richness"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Precipitation (mm)"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Species Richness"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blogpost_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="negative-binomial-model" class="level2">
<h2 class="anchored" data-anchor-id="negative-binomial-model">Negative Binomial Model</h2>
<p>Now we have totals of the number of species observed during August of each year for each River in our dataset. We also have average BFI and Precipitation for July and August, and regional averages August air temperature and flow rate across all years. I want to look at the relationship between richness and precipitation, while using flow, air temperature, and base-flow index as parameters. Since our richness is a count variable, we should use a Poisson or a Negative Binomial model. I’m choosing to use a Negative Binomial model due to the likelihood that my data is ‘overdispersed’.</p>
<p>Overdispersion occurs where the variance in the data exceeds the mean—a violation of the Poisson distribution’s assumption that mean equals variance. Ecological count data are particularly prone to overdispersion because species observations are influenced by numerous factors that can’t be accounted for in our model. Factors like sampling variations, waste discharge, and food availability. Fish communities may cluster together in very small or inaccessible locations, leading to some sites with many species and others with very few, creating higher variance than a Poisson model can accommodate. The Negative Binomial model addresses this by including an additional dispersion parameter, theta, making it more flexible and appropriate for ecological count data. Let’s take a look.</p>
<p>Let’s take a look.</p>
<p><span class="math display">\[
\begin{aligned}
Richness_{it} &amp;\sim \text{Negative Binomial}(\mu_{it}, \theta) \\
\log(\mu_{it}) &amp;= \beta_0 + \beta_1 \text{precip}_{it} + \beta_2 \text{temp}_{it} + \beta_3 \text{flow}_{it} + \beta_4 \text{bfi}_{it}
\end{aligned}
\]</span></p>
<p>Here we are modeling species Richness for each stream (i) in year (t) using a negative binomial generalized linear model. The expected richness (mu) is linked to environmental predictors through a log link function. We included monthly precipitation (precip), regional average air temperature (temp), regional average river flow (flow), and average baseflow index (bfi) as predictors for species richness. The dispersion parameter (Theta) quantifies the variability in richness beyond what would be expected under a standard Poisson model.</p>
<p>Before we specify our model, let’s take a look at it in action with simulated data.</p>
</section>
<section id="simulating-data---recovering-model-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="simulating-data---recovering-model-coefficients">Simulating Data - Recovering Model Coefficients</h2>
<p>To aide in our understanding and assess the validity of the Negative Binomial model, we want to see if it can work with fake data. In this example, we will generate a synthetic dataset with known parameters, fit our Negative Binomial model to that data, and then compare the model’s estimated coefficients to the true values we used to create the data. If the model successfully recovers parameters close to our known true values, this validates that the Negative Binomial approach is working correctly and can reliably estimate relationships in count data.</p>
<section id="generate-fake-observations" class="level5">
<h5 class="anchored" data-anchor-id="generate-fake-observations"><strong>1) Generate fake observations</strong></h5>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create fake predictor data</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>fake_obs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_mean_precip =</span> <span class="fu">runif</span>(n_obs, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">200</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_air_aug =</span> <span class="fu">runif</span>(n_obs, <span class="at">min =</span> <span class="dv">10</span>, <span class="at">max =</span> <span class="dv">25</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_flow_aug =</span> <span class="fu">runif</span>(n_obs, <span class="at">min =</span> <span class="dv">50</span>, <span class="at">max =</span> <span class="dv">300</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_mean_bfi =</span> <span class="fu">runif</span>(n_obs, <span class="at">min =</span> <span class="fl">0.2</span>, <span class="at">max =</span> <span class="fl">0.8</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="set-coefficient-values-that-well-try-to-recover-later" class="level5">
<h5 class="anchored" data-anchor-id="set-coefficient-values-that-well-try-to-recover-later"><strong>2) Set coefficient values that we’ll try to recover later</strong></h5>
<p>We’ll need an intercept (beta 0), a beta coefficient for each of our parameters values, and a dispersion parameter (theta).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set "true" coefficients</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>true_beta0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>true_beta_precip <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>true_beta_air <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.5</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>true_beta_flow <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>true_beta_bfi <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>true_theta <span class="ot">&lt;-</span> <span class="fl">2.5</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="calculate-richness-values-using-our-true-coefficient-values" class="level5">
<h5 class="anchored" data-anchor-id="calculate-richness-values-using-our-true-coefficient-values"><strong>3) Calculate richness values using our “true” coefficient values</strong></h5>
<p>Here we’re generating data that follows the rules we set above with our coefficients.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get richness in link space</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>log_richness <span class="ot">&lt;-</span> true_beta0 <span class="sc">+</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>          true_beta_precip <span class="sc">*</span> fake_obs<span class="sc">$</span>f_mean_precip <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>          true_beta_air <span class="sc">*</span> fake_obs<span class="sc">$</span>f_air_aug <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>          true_beta_flow <span class="sc">*</span> fake_obs<span class="sc">$</span>f_flow_aug <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>          true_beta_bfi <span class="sc">*</span> fake_obs<span class="sc">$</span>f_mean_bfi</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Take estimate out of link space to get actual richness values</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>richness <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_richness)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="generate-fake-richness-data-using-negative-binomial-distribution-with-rnbinom" class="level5">
<h5 class="anchored" data-anchor-id="generate-fake-richness-data-using-negative-binomial-distribution-with-rnbinom"><strong>4) Generate fake richness data using negative binomial distribution with <code>rnbinom</code></strong></h5>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fake_obs<span class="sc">$</span>richness <span class="ot">&lt;-</span> <span class="fu">rnbinom</span>(<span class="at">n =</span> n_obs, <span class="at">mu =</span> richness, <span class="at">size =</span> true_theta)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="fit-model-to-fake-data" class="level5">
<h5 class="anchored" data-anchor-id="fit-model-to-fake-data"><strong>5) Fit model to fake data</strong></h5>
<p>We’ll be using the Negative Binomial GLM function <code>glm.nb</code> from the <code>MASS</code> package.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sim_model <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(richness <span class="sc">~</span> f_mean_precip <span class="sc">+</span> f_air_aug<span class="sc">+</span> f_flow_aug <span class="sc">+</span> f_mean_bfi,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> fake_obs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="compare-estimated-coefficients-to-true-values" class="level5">
<h5 class="anchored" data-anchor-id="compare-estimated-coefficients-to-true-values"><strong>6) Compare estimated coefficients to true values</strong></h5>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Parameter =</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"Precipitation"</span>, <span class="st">"Air Temp"</span>, <span class="st">"Flow"</span>, <span class="st">"BFI"</span>, <span class="st">"Theta"</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">True_Value =</span> <span class="fu">c</span>(true_beta0, true_beta_precip, true_beta_air, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                 true_beta_flow, true_beta_bfi, true_theta),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimated_Value =</span> <span class="fu">c</span>(<span class="fu">coef</span>(sim_model), sim_model<span class="sc">$</span>theta)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display table</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(comparison, <span class="at">digits =</span> <span class="dv">4</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Comparison of True vs Estimated Parameters"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Comparison of True vs Estimated Parameters</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Parameter</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">True_Value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimated_Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">2.000</td>
<td style="text-align: right;">2.0040</td>
</tr>
<tr class="even">
<td style="text-align: left;">f_mean_precip</td>
<td style="text-align: left;">Precipitation</td>
<td style="text-align: right;">0.050</td>
<td style="text-align: right;">0.0506</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_air_aug</td>
<td style="text-align: left;">Air Temp</td>
<td style="text-align: right;">-0.500</td>
<td style="text-align: right;">-0.5071</td>
</tr>
<tr class="even">
<td style="text-align: left;">f_flow_aug</td>
<td style="text-align: left;">Flow</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">0.0010</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_mean_bfi</td>
<td style="text-align: left;">BFI</td>
<td style="text-align: right;">0.010</td>
<td style="text-align: right;">0.1625</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">Theta</td>
<td style="text-align: right;">2.500</td>
<td style="text-align: right;">3.1778</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The model successfully recovers parameters close to our true values, demonstrating that the Negative Binomial model works as expected. Now let’s apply this same approach to our real data.</p>
</section>
</section>
<section id="negative-binomial-with-actual-data" class="level2">
<h2 class="anchored" data-anchor-id="negative-binomial-with-actual-data">Negative Binomial with Actual Data</h2>
<p>Now we’ll fit our model with our actual data</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>nb_mod <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(richness <span class="sc">~</span> mean_precip <span class="sc">+</span> air_aug <span class="sc">+</span> flow_aug <span class="sc">+</span> mean_bfi,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> aug_richness</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                 )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now, let’s take a look at our model coefficients</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(nb_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">4</span>, <span class="at">caption =</span> <span class="st">"Negative Binomial Model Summary"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Negative Binomial Model Summary</caption>
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">1.6960</td>
<td style="text-align: right;">0.2022</td>
<td style="text-align: right;">8.3868</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean_precip</td>
<td style="text-align: right;">-0.0010</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">-21.2738</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">air_aug</td>
<td style="text-align: right;">0.0425</td>
<td style="text-align: right;">0.0070</td>
<td style="text-align: right;">6.0495</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">flow_aug</td>
<td style="text-align: right;">0.0049</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">2.7948</td>
<td style="text-align: right;">0.0052</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mean_bfi</td>
<td style="text-align: right;">-0.0115</td>
<td style="text-align: right;">0.0015</td>
<td style="text-align: right;">-7.8246</td>
<td style="text-align: right;">0.0000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="interpretation-of-coefficients-and-hypothesis-testing" class="level2">
<h2 class="anchored" data-anchor-id="interpretation-of-coefficients-and-hypothesis-testing">Interpretation of Coefficients and Hypothesis Testing</h2>
<p>In order to interpret our coefficients, we’ll have to take them out of log space by calculating the percentage change as <span class="math inline">\(100 \times (e^{\beta} - 1)\)</span> for positive effects or <span class="math inline">\(100 \times (1 - e^{\beta})\)</span> for negative effects. I’ll draw your attention to the mean precipitation, Theta, and Significance rows. These coefficients are what we’re most interested in for determining if our model is appropriate, and showing a relationship between our key variables - richness and precipitation.</p>
<ul>
<li><ul>
<li><strong>mean_precip (-0.001024)</strong>: Negative effect — as mean precipitation increases by one unit, expected richness decreases by ~0.10% (<span class="math inline">\(e^{-0.001024} \approx 0.999\)</span>). This suggests that higher precipitation slightly reduces fish diversity, possibly due to increased flow disturbance or habitat instability.</li>
</ul></li>
<li><p><strong>air_aug (0.04250)</strong>: Positive effect — each 1°C increase in August air temperature increases expected richness by ~4.3% (<span class="math inline">\(e^{0.04250} \approx 1.043\)</span>). Warmer temperatures may enhance metabolic rates and expand suitable habitat for diverse species.</p></li>
<li><p><strong>flow_aug (0.004867)</strong>: Positive effect — each unit increase in August river flow increases expected richness by ~0.49% (<span class="math inline">\(e^{0.004867} \approx 1.005\)</span>). Higher flows may provide more diverse habitat types and increased oxygenation.</p></li>
<li><p><strong>mean_bfi (-0.01148)</strong>: Negative effect — higher baseflow index is associated with a ~1.14% decrease in expected richness per unit (<span class="math inline">\(e^{-0.01148} \approx 0.989\)</span>). Streams with more groundwater contribution (higher BFI) tend to have less variable flow regimes, which may reduce habitat diversity.</p></li>
<li><ul>
<li><strong>Theta (4.178)</strong>: Dispersion parameter for the negative binomial, quantifying variability in richness beyond what would be expected under a Poisson model. A theta of 4.18 indicates moderate overdispersion in the data.</li>
</ul></li>
<li><ul>
<li><strong>Significance</strong>: Mean precipitation, air temperature, and BFI are highly significant (p &lt; 0.001), while flow is significant at the p &lt; 0.01 level, indicating robust associations with richness.</li>
</ul></li>
</ul>
<p>According to our results, increases in precipitation are associated with a decrease in species presence, warmer temperatures are associated with higher richness, and higher baseflow index (less stream seasonal variability) is associated with lower richness. Our Theta also indicates that the Negative Binomial model was the right choice. It looks like all of our results are statistically significant as well. This means something very important about our hypothesis from earlier. Because precipitation has a measurable effect on species richness, and our p-value for our precipitation coefficient is lower that our significance threshold of 0.05, we can <strong>reject our null hypothesis</strong> that precipitation has no effect on species richness.</p>
<p>Now, we want to see how our model performs with simulated data. Let’s see if we can recreate our results with simulated data. Once we have a viable method for simulating our data, we can bootstrap, and find out our degree of confidence in our results.</p>
</section>
<section id="building-confidence-intervals" class="level2">
<h2 class="anchored" data-anchor-id="building-confidence-intervals">Building Confidence Intervals</h2>
<p>In this final step, we want to take a look at the likelihood that our model is accurately capturing the relationship between precipitation and richness that is present in our data. In order to do that, we’ll produce 500 sets of simulated data, based on our actual data, and see how often we get similar results. To make sure we’re capturing the desired relationship, we’ll have controls for non-precipitation variables.</p>
<section id="variable-filtering" class="level5">
<h5 class="anchored" data-anchor-id="variable-filtering"><strong>1) Variable filtering</strong></h5>
<p>First, I want to filter to only my precipitation data so I can isolate the relationship between precipitations an richness. I’ll hold the other values constant by using their median value.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>precip_only_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_precip =</span> <span class="fu">seq</span>(<span class="fu">min</span>(aug_richness<span class="sc">$</span>mean_precip), </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">max</span>(aug_richness<span class="sc">$</span>mean_precip), </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">air_aug =</span> <span class="fu">median</span>(aug_richness<span class="sc">$</span>air_aug),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">flow_aug =</span> <span class="fu">median</span>(aug_richness<span class="sc">$</span>flow_aug),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_bfi =</span> <span class="fu">median</span>(aug_richness<span class="sc">$</span>mean_bfi)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="bootstrapping" class="level5">
<h5 class="anchored" data-anchor-id="bootstrapping"><strong>2) Bootstrapping</strong></h5>
<p>Bootstrapping is a resampling technique that allows us to estimate the uncertainty in our model predictions by repeatedly sampling from our actual data with replacement. In this context, we’ll simulate 500 new datasets based on our actual data, fit the negative binomial model to each simulated dataset, and generate predictions for richness. This process creates a distribution of predicted richness values for each precipitation level, which we can use to calculate confidence intervals. Confidence intervals will tell us about the likelihood that we’re capturing the actual relationship between precipitation and richness from our data with our model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define number of simulations</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a matrix to populate with bootstrap data, same rows as our precip_only_data  and one column for each simulation</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>pred_matrix_boot <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(precip_only_data), <span class="at">ncol =</span> n_sims)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap for each simulation</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims){</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap: resample original data</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  boot_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(aug_richness), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  boot_data <span class="ot">&lt;-</span> aug_richness[boot_indices, ]</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit model to bootstrap sample</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  boot_mod <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(richness <span class="sc">~</span> mean_precip <span class="sc">+</span> air_aug <span class="sc">+</span> flow_aug <span class="sc">+</span> mean_bfi,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> boot_data)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on precip_only_data </span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  pred_matrix_boot[,i] <span class="ot">&lt;-</span> <span class="fu">predict</span>(boot_mod, <span class="at">newdata =</span> precip_only_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="confidence-intervals" class="level5">
<h5 class="anchored" data-anchor-id="confidence-intervals"><strong>3) Confidence Intervals</strong></h5>
<p>Third, I will define my 5% confidence intervals, and then add those values to my <code>precip_only_data</code> dataframe</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate confidence intervals</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(pred_matrix_boot)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>pred_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(pred_matrix_boot, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>pred_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(pred_matrix_boot, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to precip_only_data</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>precip_only_data <span class="ot">&lt;-</span> precip_only_data <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_mean  =</span> pred_mean,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_lower =</span> pred_lower,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_upper =</span> pred_upper</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now that we have our predictions for precipitation based on simulations, while holding all other variables constant, we can plot our data with confidence intervals</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(precip_only_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_precip, <span class="at">y =</span> pred_mean)) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> pred_lower, <span class="at">ymax =</span> pred_upper), <span class="co"># Confidence intervals</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">fill =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="co"># </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Precipitation (mm)"</span>, </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Species Richness (count)"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Precipitation on Fish Species Richness"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Other variables held at median values (95% CI from 500 bootstrap samples)"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="blogpost_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>–</p>
<p><strong>Interpretation: What do the confidence intervals tell us?</strong></p>
<p>Based on 500 bootstrap samples of the data, we’re 95% confident that the true relationship between precipitation and fish species richness falls somewhere within the shaded red region. The line shows our best estimate, and the ribbon shows how uncertain we are about that estimate. It’s important to understand that this is not a direct representation of how accurate precipitation is in predicting fish richness. Rather, This interval represents parameter uncertainty - how confident we are about the relationship between precipitation and richness - rather than prediction uncertainty for individual streams. Based on the figure,it look like our model has high confidence of capturing the relationship between richness and precipitation present in our data. The model is likely most accurate to the true relationship between precipitation and richness in the 750-1000mm precipitation range, and least accurate in the 0-500 range. This is likely because there is more data in the former range, and higher variation of richness in the 0-500 range.</p>
</section>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>These results demonstrate that precipitation exhibits a clear, model-able, and reproducible association with freshwater fish species richness across rivers and streams in the Northwestern United States. While this relationship does not directly translate into precise predictions for any single stream, the consistent pattern observed in our data indicates that precipitation remains an ecologically meaningful variable and should continue to be collected and incorporated into richness analyses. Future work would benefit from exploring time-lagged precipitation effects, which may capture delayed ecological responses and provide a more comprehensive understanding of how hydrologic patterns shape biodiversity over longer temporal scales.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>[1] Clancy, N. (2024). Dataset of Species Presence Locations for 116 Freshwater Fish Species in Wyoming, Montana, and the Surrounding States from 1800–2022 (Data release). U.S. Geological Survey. https://doi.org/10.5066/P13OGUSE</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>